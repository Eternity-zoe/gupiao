// Ëá™ÈÄâËÇ°È°µÈù¢
import { StorageService } from '../service/StorageService';
import { StockService } from '../service/StockService';
import { StockGroup, StockInfo, SearchStockItem } from '../model/StockData';
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { promptAction } from '@kit.ArkUI';

interface GroupStats {
  upCount: number;
  downCount: number;
  flatCount: number;
  avgChange: string;
  totalVolume: number;
  totalAmount: number;
}

@Component
export struct FavoritePage {
  @State stockGroups: StockGroup[] = [];
  @State currentGroupIndex: number = 0;
  @State stockDataMap: Map<string, StockInfo> = new Map();
  @State isLoading: boolean = false;
  @State refreshTime: string = '';
  @State showSearchDialog: boolean = false;
  @State searchKeyword: string = '';
  @State autoRefreshEnabled: boolean = true;
  @State followGroupSwitch: boolean = false;
  @State groupStats: GroupStats | null = null;
  @State searchResults: SearchStockItem[] = [];
  @State isSearching: boolean = false;
  private refreshTimer: number = -1;
  private searchTimer: number = -1;

  async aboutToAppear() {
    // Âä†ËΩΩÂ≠òÂÇ®ÁöÑÊï∞ÊçÆ
    await this.loadSavedData();
    // ÂàùÂßãÂåñÁªüËÆ°Êï∞ÊçÆ
    this.groupStats = this.getGroupStats();
    // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÔºàÂèØÈÖçÁΩÆÔºâ
    this.startAutoRefresh();
  }

  startAutoRefresh() {
    if (this.refreshTimer !== -1) {
      clearInterval(this.refreshTimer);
    }
    
    if (this.autoRefreshEnabled) {
      this.refreshTimer = setInterval(() => {
        // Âè™ÊúâÂΩìÂâçÂàÜÁªÑÊúâËÇ°Á•®Êó∂ÊâçÂà∑Êñ∞
        if (this.stockGroups.length > 0 && 
            this.stockGroups[this.currentGroupIndex] && 
            this.stockGroups[this.currentGroupIndex].stocks.length > 0) {
          this.loadData();
        }
      }, 30000); // 30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
    }
  }

  async loadSavedData() {
    try {
      // Âä†ËΩΩËÇ°Á•®ÂàÜÁªÑ
      this.stockGroups = await StorageService.getStockGroups();
      
      // Âä†ËΩΩ‰øùÂ≠òÁöÑËÇ°Á•®Êï∞ÊçÆ
      const savedStockData = await StorageService.getStockDataMap();
      const savedTime = await StorageService.getStockRefreshTime();
      
      this.stockDataMap = savedStockData;
      this.refreshTime = savedTime;
      
      console.info(`‰ªéÂ≠òÂÇ®Âä†ËΩΩËÇ°Á•®Êï∞ÊçÆ: ${savedStockData.size}Âè™ËÇ°Á•®`);
    } catch (error) {
      console.error('Âä†ËΩΩ‰øùÂ≠òÁöÑËÇ°Á•®Êï∞ÊçÆÂ§±Ë¥•:', error);
    }
  }

  aboutToDisappear() {
    if (this.refreshTimer !== -1) {
      clearInterval(this.refreshTimer);
    }
  }

  async loadData() {
    this.isLoading = true;

    try {
      this.stockGroups = await StorageService.getStockGroups();
      console.info(`[Ëá™ÈÄâËÇ°] Âä†ËΩΩÂàÜÁªÑ: ${this.stockGroups.length}‰∏™`);

      if (this.stockGroups.length > 0) {
        if (this.stockGroups[this.currentGroupIndex] &&
            this.stockGroups[this.currentGroupIndex].stocks.length > 0) {

          const stocks = this.stockGroups[this.currentGroupIndex].stocks;
          console.info(`[Ëá™ÈÄâËÇ°] ÂΩìÂâçÂàÜÁªÑËÇ°Á•®: ${stocks.join(', ')}`);

          const newStockData = await StockService.getMultipleStocks(stocks);
          console.info(`[Ëá™ÈÄâËÇ°] APIËøîÂõû: ${newStockData.size}Âè™ËÇ°Á•®`);

          if (newStockData.size > 0) {
            // Ëé∑ÂèñÂà∞Êñ∞Êï∞ÊçÆÔºå‰øùÂ≠òÂπ∂‰ΩøÁî®
            this.stockDataMap = newStockData;
            await StorageService.saveStockDataMap(newStockData);

            const now = new Date();
            this.refreshTime = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            await StorageService.saveStockRefreshTime(this.refreshTime);

            console.info(`[Ëá™ÈÄâËÇ°] Ëé∑ÂèñÊàêÂäü: ${newStockData.size}Âè™ËÇ°Á•®`);
          } else {
            // APIÁî®ÂÆåÊàñÂ§±Ë¥•Ôºå‰ΩøÁî®Â≠òÂÇ®ÁöÑÊï∞ÊçÆ
            console.warn('[Ëá™ÈÄâËÇ°] APIËøîÂõûÁ©∫Ôºå‰ΩøÁî®Â≠òÂÇ®ÁöÑËÇ°Á•®Êï∞ÊçÆ');
            const savedStockData = await StorageService.getStockDataMap();
            const savedTime = await StorageService.getStockRefreshTime();

            if (savedStockData.size > 0) {
              this.stockDataMap = savedStockData;
              this.refreshTime = savedTime || 'ÁºìÂ≠òÊï∞ÊçÆ';
            } else {
              // ÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ
              this.generateMockStockData();
              this.refreshTime = 'Ê®°ÊãüÊï∞ÊçÆ';
            }
          }
        }
      }
    } catch (error) {
      console.error('[Ëá™ÈÄâËÇ°] Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
      
      // Âä†ËΩΩÂ§±Ë¥•Êó∂‰ΩøÁî®Â≠òÂÇ®ÁöÑÊï∞ÊçÆ
      const savedStockData = await StorageService.getStockDataMap();
      const savedTime = await StorageService.getStockRefreshTime();
      
      if (savedStockData.size > 0) {
        this.stockDataMap = savedStockData;
        this.refreshTime = savedTime || 'ÁºìÂ≠òÊï∞ÊçÆ';
      } else {
        this.generateMockStockData();
        this.refreshTime = 'Ê®°ÊãüÊï∞ÊçÆ';
      }
    }
    
    // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
    this.groupStats = this.getGroupStats();
    
    this.isLoading = false;
  }

  // ÁîüÊàêÊ®°ÊãüËÇ°Á•®Êï∞ÊçÆ
  generateMockStockData() {
    const mockData = new Map<string, StockInfo>();
    
    if (this.stockGroups.length > 0 && this.stockGroups[this.currentGroupIndex]) {
      const stocks = this.stockGroups[this.currentGroupIndex].stocks;
      
      stocks.forEach((gid: string) => {
        const mockStock: StockInfo = {
          data: {
            gid: gid,
            name: this.getStockName(gid),
            nowPri: (Math.random() * 50 + 10).toFixed(2),
            increPer: ((Math.random() - 0.5) * 10).toFixed(2),
            increase: ((Math.random() - 0.5) * 2).toFixed(2),
            todayStartPri: (Math.random() * 50 + 10).toFixed(2),
            todayMax: (Math.random() * 50 + 10).toFixed(2),
            todayMin: (Math.random() * 50 + 10).toFixed(2),
            yestodEndPri: (Math.random() * 50 + 10).toFixed(2),
            competitivePri: (Math.random() * 50 + 10).toFixed(2),
            reservePri: (Math.random() * 50 + 10).toFixed(2),
            traNumber: Math.floor(Math.random() * 1000000).toString(),
            traAmount: Math.floor(Math.random() * 10000000).toString(),
            buyOne: (Math.random() * 50 + 10).toFixed(2),
            buyOnePri: Math.floor(Math.random() * 1000).toString(),
            buyTwo: (Math.random() * 50 + 10).toFixed(2),
            buyTwoPri: Math.floor(Math.random() * 1000).toString(),
            buyThree: (Math.random() * 50 + 10).toFixed(2),
            buyThreePri: Math.floor(Math.random() * 1000).toString(),
            buyFour: (Math.random() * 50 + 10).toFixed(2),
            buyFourPri: Math.floor(Math.random() * 1000).toString(),
            buyFive: (Math.random() * 50 + 10).toFixed(2),
            buyFivePri: Math.floor(Math.random() * 1000).toString(),
            sellOne: (Math.random() * 50 + 10).toFixed(2),
            sellOnePri: Math.floor(Math.random() * 1000).toString(),
            sellTwo: (Math.random() * 50 + 10).toFixed(2),
            sellTwoPri: Math.floor(Math.random() * 1000).toString(),
            sellThree: (Math.random() * 50 + 10).toFixed(2),
            sellThreePri: Math.floor(Math.random() * 1000).toString(),
            sellFour: (Math.random() * 50 + 10).toFixed(2),
            sellFourPri: Math.floor(Math.random() * 1000).toString(),
            sellFive: (Math.random() * 50 + 10).toFixed(2),
            sellFivePri: Math.floor(Math.random() * 1000).toString(),
            date: new Date().toLocaleDateString(),
            time: new Date().toLocaleTimeString()
          },
          gopicture: {
            minurl: '',
            dayurl: '',
            weekurl: '',
            monthurl: ''
          }
        };
        mockData.set(gid, mockStock);
      });
    }
    
    this.stockDataMap = mockData;
  }

  // Ëé∑ÂèñËÇ°Á•®ÂêçÁß∞
  getStockName(gid: string): string {
    const nameMap: Record<string, string> = {
      'sh601009': 'Âçó‰∫¨Èì∂Ë°å',
      'sh600036': 'ÊãõÂïÜÈì∂Ë°å', 
      'sz000001': 'Âπ≥ÂÆâÈì∂Ë°å',
      'sh600000': 'Êµ¶ÂèëÈì∂Ë°å'
    };
    return nameMap[gid] || 'Êú™Áü•ËÇ°Á•®';
  }

  build() {
    Column() {
      // È°∂ÈÉ®Ê†è
      this.buildHeader();
      
      // ÂàÜÁªÑÊ†áÁ≠æ
      if (this.stockGroups.length > 0) {
        this.buildGroupTabs();
        
        // ÂàÜÁªÑÁªüËÆ°
        this.buildGroupStats();
      }
      
      // ËÇ°Á•®ÂàóË°®
      this.buildStockList();
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    .bindContentCover(this.showSearchDialog, this.buildSearchDialog(), {
      modalTransition: ModalTransition.DEFAULT
    })
  }

  @Builder
  buildHeader() {
    Column() {
      Row() {
        Text('Ëá™ÈÄâËÇ°')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')

        Blank()

        if (this.refreshTime) {
          Text(`${this.refreshTime}`)
            .fontSize(12)
            .fontColor(this.refreshTime === 'Ê®°ÊãüÊï∞ÊçÆ' ? '#FF6B35' : '#999999')
            .fontWeight(this.refreshTime === 'Ê®°ÊãüÊï∞ÊçÆ' ? FontWeight.Bold : FontWeight.Normal)
            .margin({ right: 12 })
        }

        // Ëá™Âä®Âà∑Êñ∞ÂºÄÂÖ≥
        Row() {
          Text('Ëá™Âä®')
            .fontSize(10)
            .fontColor(this.autoRefreshEnabled ? '#0A59F7' : '#999999')
          Toggle({ type: ToggleType.Switch, isOn: this.autoRefreshEnabled })
            .width(30)
            .height(16)
            .onChange((isOn: boolean) => {
              this.autoRefreshEnabled = isOn;
              this.startAutoRefresh();
            })
        }
        .margin({ right: 8 })

        // Âà∑Êñ∞ÊåâÈíÆ
        Text('Âà∑Êñ∞')
          .fontSize(14)
          .fontColor('#0A59F7')
          .margin({ right: 12 })
          .onClick(() => {
            if (!this.isLoading) {
              this.loadData();
            }
          })

        // ÁÆ°ÁêÜÊåâÈíÆ
        Text('ÁÆ°ÁêÜ')
          .fontSize(14)
          .fontColor('#0A59F7')
          .onClick(() => {
            router.pushUrl({ url: 'pages/GroupManage' }, router.RouterMode.Standard);
          })
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })

      // ÊêúÁ¥¢Ê°ÜÂÖ•Âè£
      Row() {
        Text('üîç')
          .fontSize(16)
          .margin({ right: 8 })

        Text('ÊêúÁ¥¢ËÇ°Á•®‰ª£Á†Å„ÄÅÂêçÁß∞ÊàñÊãºÈü≥È¶ñÂ≠óÊØç')
          .fontSize(14)
          .fontColor('#999999')
      }
      .width('100%')
      .height(40)
      .padding({ left: 12, right: 12 })
      .margin({ left: 16, right: 16, bottom: 8 })
      .backgroundColor('#F5F5F5')
      .borderRadius(20)
      .onClick(() => {
        this.showSearchDialog = true;
      })
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
  }

  @Builder
  buildGroupTabs() {
    Scroll() {
      Row() {
        ForEach(this.stockGroups, (group: StockGroup, index: number) => {
          Text(group.name)
            .fontSize(14)
            .fontColor(this.currentGroupIndex === index ? '#0A59F7' : '#666666')
            .fontWeight(this.currentGroupIndex === index ? FontWeight.Bold : FontWeight.Normal)
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .borderRadius(4)
            .backgroundColor(this.currentGroupIndex === index ? '#E8F2FF' : 'transparent')
            .onClick(() => {
              this.currentGroupIndex = index;
              // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
              this.groupStats = this.getGroupStats();
              // Â¶ÇÊûúÂºÄÂêØË∑üÈöèÂà∑Êñ∞ÔºåÂàáÊç¢ÂàÜÁªÑÂêéËá™Âä®Âà∑Êñ∞
              if (this.followGroupSwitch) {
                this.loadData();
              }
            })
        })
      }
      .padding({ left: 16, right: 16 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .width('100%')
    .backgroundColor('#FFFFFF')
    .padding({ top: 8, bottom: 8 })
    .margin({ top: 1 })
  }

  @Builder
  buildStockList() {
    if (this.stockGroups.length === 0) {
      Column() {
        Image($r('app.media.layered_image'))
          .width(80)
          .height(80)
          .margin({ bottom: 16 })
        
        Text('ÊöÇÊó†ÂàÜÁªÑ')
          .fontSize(16)
          .fontColor('#999999')
        
        Text('ÁÇπÂáªÂè≥‰∏äËßí"ÁÆ°ÁêÜ"ÂàõÂª∫ÂàÜÁªÑ')
          .fontSize(12)
          .fontColor('#CCCCCC')
          .margin({ top: 8 })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else if (this.stockGroups.length > 0 && this.currentGroupIndex < this.stockGroups.length) {
      // È¶ñÊ¨°Âä†ËΩΩÊèêÁ§∫
      if (this.stockDataMap.size === 0 && !this.isLoading && this.stockGroups[this.currentGroupIndex].stocks.length > 0) {
        Column() {
          Text('ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÁÇπÂáªÂè≥‰∏äËßí"Âà∑Êñ∞"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞ËÇ°Á•®Êï∞ÊçÆ')
            .fontSize(14)
            .fontColor('#666666')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F0F8FF')
        .borderRadius(8)
        .margin(16)
      }
      
      List() {
        if (this.stockGroups[this.currentGroupIndex].stocks.length === 0) {
          ListItem() {
            Column() {
              Image($r('app.media.layered_image'))
                .width(80)
                .height(80)
                .margin({ bottom: 16 })
              
              Text('ÊöÇÊó†Ëá™ÈÄâËÇ°')
                .fontSize(16)
                .fontColor('#999999')
              
              Text('ÁÇπÂáªÂè≥‰∏äËßíÊêúÁ¥¢ÂõæÊ†áÊ∑ªÂä†ËÇ°Á•®')
                .fontSize(12)
                .fontColor('#CCCCCC')
                .margin({ top: 8 })
            }
            .width('100%')
            .height(300)
            .justifyContent(FlexAlign.Center)
          }
        } else {
          ForEach(this.stockGroups[this.currentGroupIndex].stocks, (gid: string) => {
            ListItem() {
              this.buildStockItem(gid);
            }
            .onClick(() => {
              router.pushUrl({ 
                url: 'pages/StockDetail',
                params: { gid: gid }
              }, router.RouterMode.Standard);
            })
          })
        }
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#FFFFFF')
      .margin({ top: 8 })
      .divider({
        strokeWidth: 1,
        color: '#F5F5F5'
      })
    }
  }

  @Builder
  buildStockItem(gid: string) {
    Row() {
      Column() {
        Text(this.stockDataMap.get(gid)?.data.name || gid)
          .fontSize(16)
          .fontColor('#1A1A1A')
          .fontWeight(FontWeight.Medium)
        
        Text(gid.toUpperCase())
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      if (this.stockDataMap.get(gid)) {
        Column() {
          Text(this.stockDataMap.get(gid)!.data.nowPri)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(parseFloat(this.stockDataMap.get(gid)!.data.increPer) >= 0 ? '#E64545' : '#00B578')
          
          Row() {
            Text(`${parseFloat(this.stockDataMap.get(gid)!.data.increPer) >= 0 ? '+' : ''}${this.stockDataMap.get(gid)!.data.increase}`)
              .fontSize(12)
              .fontColor(parseFloat(this.stockDataMap.get(gid)!.data.increPer) >= 0 ? '#E64545' : '#00B578')
            
            Text(`${parseFloat(this.stockDataMap.get(gid)!.data.increPer) >= 0 ? '+' : ''}${this.stockDataMap.get(gid)!.data.increPer}%`)
              .fontSize(12)
              .fontColor(parseFloat(this.stockDataMap.get(gid)!.data.increPer) >= 0 ? '#E64545' : '#00B578')
              .padding({ left: 4, right: 4, top: 2, bottom: 2 })
              .backgroundColor(parseFloat(this.stockDataMap.get(gid)!.data.increPer) >= 0 ? '#FFEBEE' : '#E8F5E9')
              .borderRadius(2)
              .margin({ left: 6 })
          }
          .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.End)
      } else {
        Text('Âä†ËΩΩ‰∏≠...')
          .fontSize(14)
          .fontColor('#999999')
      }
    }
    .width('100%')
    .padding(16)
  }

  @Builder
  buildSearchDialog() {
    Column() {
      // ÊêúÁ¥¢Ê°Ü
      Column() {
        Row() {
          Image($r('app.media.layered_image'))
            .width(20)
            .height(20)
            .margin({ right: 8 })

          TextInput({ placeholder: 'ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å„ÄÅÂêçÁß∞ÊàñÊãºÈü≥È¶ñÂ≠óÊØç' })
            .layoutWeight(1)
            .backgroundColor('transparent')
            .onChange((value: string) => {
              this.searchKeyword = value;
              this.performSearch(value);
            })

          if (this.isSearching) {
            LoadingProgress()
              .width(20)
              .height(20)
              .margin({ left: 8 })
          }

          Text('ÂèñÊ∂à')
            .fontSize(14)
            .fontColor('#0A59F7')
            .margin({ left: 8 })
            .onClick(() => {
              this.showSearchDialog = false;
              this.searchKeyword = '';
              this.searchResults = [];
            })
        }
        .width('100%')
        .height(48)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#F5F5F5')
        .borderRadius(8)
        .margin({ top: 16, left: 16, right: 16 })

        // ÊêúÁ¥¢‰∏≠Áä∂ÊÄÅ
        if (this.isSearching) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
            Text(`Ê≠£Âú®ÊêúÁ¥¢ "${this.searchKeyword}"...`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        }
        // ÊêúÁ¥¢ÁªìÊûúÂàóË°®
        else if (this.searchResults.length > 0) {
          Column() {
            Text(`ÊâæÂà∞ ${this.searchResults.length} ‰∏™ÁªìÊûú`)
              .fontSize(12)
              .fontColor('#666666')
              .margin({ left: 16, top: 8, bottom: 4 })
              .width('100%')

            List() {
              ForEach(this.searchResults, (item: SearchStockItem) => {
                ListItem() {
                  this.buildSearchResultItem(item);
                }
                .onClick(() => {
                  this.addStockFromSearch(item);
                })
              })
            }
            .width('100%')
            .layoutWeight(1)
            .backgroundColor('#FFFFFF')
            .divider({ strokeWidth: 1, color: '#F0F0F0' })
          }
          .width('100%')
          .height(400)
        } else if (this.searchKeyword.trim() && !this.isSearching) {
          // Êó†ÁªìÊûúÊèêÁ§∫
          Column() {
            Text('üòï')
              .fontSize(40)
              .margin({ bottom: 12 })

            Text(`Êú™ÊâæÂà∞ "${this.searchKeyword}" Áõ∏ÂÖ≥ËÇ°Á•®`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 16 })

            Text('ËØ∑Â∞ùËØïÔºö')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ bottom: 8 })

            Column() {
              Text('‚Ä¢ ËæìÂÖ•ÂÆåÊï¥ËÇ°Á•®‰ª£Á†ÅÔºåÂ¶Ç 600519')
                .fontSize(12)
                .fontColor('#999999')
              Text('‚Ä¢ ËæìÂÖ•ËÇ°Á•®ÂêçÁß∞ÔºåÂ¶Ç Ë¥µÂ∑ûËåÖÂè∞')
                .fontSize(12)
                .fontColor('#999999')
                .margin({ top: 4 })
              Text('‚Ä¢ ËæìÂÖ•ÊãºÈü≥È¶ñÂ≠óÊØçÔºåÂ¶Ç gzmt')
                .fontSize(12)
                .fontColor('#999999')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
          .padding(32)
          .justifyContent(FlexAlign.Center)
        } else if (!this.searchKeyword.trim()) {
          // ÈªòËÆ§ÊèêÁ§∫
          Column() {
            Text('ÊêúÁ¥¢ËØ¥Êòé')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')
              .margin({ bottom: 12 })

            Column() {
              this.buildSearchTip('ËÇ°Á•®‰ª£Á†Å', 'Áõ¥Êé•ËæìÂÖ•6‰ΩçÊï∞Â≠ó', '600519');
              this.buildSearchTip('ËÇ°Á•®ÂêçÁß∞', 'ËæìÂÖ•‰∏≠ÊñáÂêçÁß∞', 'Ë¥µÂ∑ûËåÖÂè∞');
              this.buildSearchTip('ÊãºÈü≥È¶ñÂ≠óÊØç', 'ËæìÂÖ•ÊãºÈü≥È¶ñÂ≠óÊØç', 'gzmt / payh');
            }

            Text('ÊîØÊåÅAËÇ°„ÄÅÊ∏ØËÇ°„ÄÅÁæéËÇ°ÊêúÁ¥¢')
              .fontSize(12)
              .fontColor('#666666')
              .margin({ top: 16 })
          }
          .width('100%')
          .padding(16)
          .alignItems(HorizontalAlign.Start)
        }
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius({ topLeft: 12, topRight: 12 })
      .margin({ top: 60 })

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
  }

  @Builder
  buildSearchResultItem(item: SearchStockItem) {
    Row() {
      Column() {
        Row() {
          Text(item.name)
            .fontSize(16)
            .fontColor('#1A1A1A')
            .fontWeight(FontWeight.Medium)

          Text(item.financeType === 'index' ? 'ÊåáÊï∞' : (item.financeType === 'fund' ? 'Âü∫Èáë' : ''))
            .fontSize(10)
            .fontColor('#FFFFFF')
            .backgroundColor(item.financeType === 'index' ? '#FF9800' : '#2196F3')
            .padding({ left: 4, right: 4, top: 2, bottom: 2 })
            .borderRadius(2)
            .margin({ left: 6 })
            .visibility(item.financeType !== 'stock' ? Visibility.Visible : Visibility.None)
        }

        Text(`${item.exchange}${item.code}`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Column() {
        Text(item.price || '--')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getPriceColor(item.ratio))

        Text(item.ratio || '--')
          .fontSize(12)
          .fontColor(this.getPriceColor(item.ratio))
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.End)

      Image($r('app.media.layered_image'))
        .width(20)
        .height(20)
        .margin({ left: 12 })
        .fillColor('#0A59F7')
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
  }

  getPriceColor(ratio: string): string {
    if (!ratio) return '#333333';
    if (ratio.startsWith('+')) return '#E64545';
    if (ratio.startsWith('-')) return '#00B578';
    return '#333333';
  }

  // ÊâßË°åÊêúÁ¥¢ - ÊØèËæìÂÖ•‰∏Ä‰∏™Â≠óÁ¨¶Â∞±ÊêúÁ¥¢
  performSearch(keyword: string) {
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
    if (this.searchTimer !== -1) {
      clearTimeout(this.searchTimer);
    }

    const trimmed = keyword.trim();
    if (!trimmed) {
      this.searchResults = [];
      this.isSearching = false;
      return;
    }

    // Á´ãÂç≥ÊòæÁ§∫ÊêúÁ¥¢‰∏≠Áä∂ÊÄÅ
    this.isSearching = true;

    // Èò≤Êäñ100msÔºåÈÅøÂÖçËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅ
    this.searchTimer = setTimeout(async () => {
      console.info(`ÂºÄÂßãÊêúÁ¥¢: ${trimmed}`);
      try {
        const results = await StockService.searchStock(trimmed);
        console.info(`ÊêúÁ¥¢ÁªìÊûú: ${results.length}Êù°`);
        // Âè™ÊúâÂΩìÊêúÁ¥¢ÂÖ≥ÈîÆËØçÊ≤°ÂèòÊó∂ÊâçÊõ¥Êñ∞ÁªìÊûú
        if (this.searchKeyword.trim() === trimmed) {
          this.searchResults = results;
        }
      } catch (error) {
        console.error('ÊêúÁ¥¢Â§±Ë¥•:', error);
        this.searchResults = [];
      }
      this.isSearching = false;
    }, 100);
  }

  // ‰ªéÊêúÁ¥¢ÁªìÊûúÊ∑ªÂä†ËÇ°Á•®
  async addStockFromSearch(item: SearchStockItem) {
    try {
      if (this.stockGroups.length === 0) {
        promptAction.showToast({
          message: 'ËØ∑ÂÖàÂàõÂª∫ÂàÜÁªÑ',
          duration: 2000
        });
        this.showSearchDialog = false;
        router.pushUrl({ url: 'pages/GroupManage' }, router.RouterMode.Standard);
        return;
      }

      const gid = StockService.convertToGid(item);
      const currentGroup = this.stockGroups[this.currentGroupIndex];

      if (currentGroup.stocks.includes(gid)) {
        promptAction.showToast({
          message: 'ËØ•ËÇ°Á•®Â∑≤Âú®Ëá™ÈÄâ‰∏≠',
          duration: 2000
        });
        return;
      }

      await StorageService.addStockToGroup(currentGroup.id, gid);
      this.stockGroups = await StorageService.getStockGroups();

      this.showSearchDialog = false;
      this.searchKeyword = '';
      this.searchResults = [];

      promptAction.showToast({
        message: `Â∑≤Ê∑ªÂä† ${item.name}ÔºåËØ∑ÁÇπÂáªÂà∑Êñ∞Ëé∑ÂèñÊï∞ÊçÆ`,
        duration: 2000
      });
    } catch (err) {
      console.error('Ê∑ªÂä†ËÇ°Á•®Â§±Ë¥•:', err);
      promptAction.showToast({
        message: 'Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
        duration: 2000
      });
    }
  }

  @Builder
  buildSearchTip(title: string, format: string, example: string) {
    Row() {
      Column() {
        Text(title)
          .fontSize(14)
          .fontColor('#1A1A1A')
        
        Text(format)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      Text(example)
        .fontSize(12)
        .fontColor('#0A59F7')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#F8F8F8')
    .borderRadius(8)
    .margin({ bottom: 8 })
  }

  async addStock() {
    try {
      const stockCode = this.searchKeyword.trim().toLowerCase();
      
      if (!stockCode) {
        promptAction.showToast({
          message: 'ËØ∑ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å',
          duration: 2000
        });
        return;
      }
      
      // È™åËØÅÊ†ºÂºè
      if (!stockCode.startsWith('sh') && !stockCode.startsWith('sz')) {
        promptAction.showToast({
          message: 'ËÇ°Á•®‰ª£Á†ÅÊ†ºÂºèÈîôËØØÔºåÂøÖÈ°ª‰ª•shÊàñszÂºÄÂ§¥',
          duration: 2000
        });
        return;
      }
      
      if (this.stockGroups.length === 0) {
        promptAction.showToast({
          message: 'ËØ∑ÂÖàÂàõÂª∫ÂàÜÁªÑ',
          duration: 2000
        });
        this.showSearchDialog = false;
        router.pushUrl({ url: 'pages/GroupManage' }, router.RouterMode.Standard);
        return;
      }
      
      const currentGroup = this.stockGroups[this.currentGroupIndex];
      
      if (currentGroup.stocks.includes(stockCode)) {
        promptAction.showToast({
          message: 'ËØ•ËÇ°Á•®Â∑≤Âú®Ëá™ÈÄâ‰∏≠',
          duration: 2000
        });
        return;
      }
      
      await StorageService.addStockToGroup(currentGroup.id, stockCode);
      // ÁßªÈô§Ëá™Âä®Âä†ËΩΩÔºåÊèêÁ§∫Áî®Êà∑ÊâãÂä®Âà∑Êñ∞
      this.stockGroups = await StorageService.getStockGroups();
      
      this.showSearchDialog = false;
      this.searchKeyword = '';
      
      promptAction.showToast({
        message: 'Ê∑ªÂä†ÊàêÂäüÔºåËØ∑ÁÇπÂáªÂà∑Êñ∞Ëé∑ÂèñÊï∞ÊçÆ',
        duration: 2000
      });
    } catch (err) {
      console.error('Ê∑ªÂä†ËÇ°Á•®Â§±Ë¥•:', err);
      promptAction.showToast({
        message: 'Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑ÈáçËØï',
        duration: 2000
      });
    }
  }

  // ËÆ°ÁÆóÂàÜÁªÑÁªüËÆ°Êï∞ÊçÆ
  private getGroupStats(): GroupStats | null {
    if (this.stockGroups.length === 0 || this.currentGroupIndex >= this.stockGroups.length) {
      return null;
    }

    const currentGroup = this.stockGroups[this.currentGroupIndex];
    const groupStocks = currentGroup.stocks;
    
    if (groupStocks.length === 0) {
      return null;
    }

    let upCount = 0;
    let downCount = 0;
    let flatCount = 0;
    let totalChange = 0;
    let totalVolume = 0;
    let totalAmount = 0;

    groupStocks.forEach((gid: string) => {
      const stockData = this.stockDataMap.get(gid);
      if (stockData) {
        const changePercent = parseFloat(stockData.data.increPer);
        if (changePercent > 0) {
          upCount++;
        } else if (changePercent < 0) {
          downCount++;
        } else {
          flatCount++;
        }
        totalChange += changePercent;
        totalVolume += parseFloat(stockData.data.traNumber) || 0;
        totalAmount += parseFloat(stockData.data.traAmount) || 0;
      }
    });

    const avgChange = groupStocks.length > 0 ? (totalChange / groupStocks.length).toFixed(2) : '0.00';
    
    const result: GroupStats = {
      upCount: upCount,
      downCount: downCount,
      flatCount: flatCount,
      avgChange: avgChange,
      totalVolume: totalVolume,
      totalAmount: totalAmount
    };
    return result;
  }

  @Builder
  buildGroupStats() {
    if (this.groupStats) {
      Row() {
        // Ê∂®Ë∑åÁªüËÆ°
        Column() {
          Text('Ê∂®Ë∑åÂàÜÂ∏É')
            .fontSize(10)
            .fontColor('#666666')
          
          Row() {
            Text(`‚Üë${this.groupStats.upCount}`)
              .fontSize(12)
              .fontColor('#E64545')
              .margin({ right: 8 })
            
            Text(`‚Üì${this.groupStats.downCount}`)
              .fontSize(12)
              .fontColor('#00B578')
              .margin({ right: 8 })
            
            Text(`‚Üí${this.groupStats.flatCount}`)
              .fontSize(12)
              .fontColor('#999999')
          }
          .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        // Âπ≥ÂùáÊ∂®Ë∑åÂπÖ
        Column() {
          Text('Âπ≥ÂùáÊ∂®Ë∑å')
            .fontSize(10)
            .fontColor('#666666')
          
          Text(`${parseFloat(this.groupStats.avgChange) >= 0 ? '+' : ''}${this.groupStats.avgChange}%`)
            .fontSize(12)
            .fontColor(parseFloat(this.groupStats.avgChange) >= 0 ? '#E64545' : '#00B578')
            .fontWeight(FontWeight.Bold)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        
        // ÊÄªÊàê‰∫§Èáè
        Column() {
          Text('ÊÄªÊàê‰∫§Èáè')
            .fontSize(10)
            .fontColor('#666666')
          
          Text(`${(this.groupStats.totalVolume / 10000).toFixed(0)}‰∏á`)
            .fontSize(12)
            .fontColor('#333333')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Center)
        .layoutWeight(1)
        
        // ÊÄªÊàê‰∫§È¢ù
        Column() {
          Text('ÊÄªÊàê‰∫§È¢ù')
            .fontSize(10)
            .fontColor('#666666')
          
          Text(`${(this.groupStats.totalAmount / 100000000).toFixed(1)}‰∫ø`)
            .fontSize(12)
            .fontColor('#333333')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.End)
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#F8F8F8')
      .margin({ top: 1 })
    }
  }
}
